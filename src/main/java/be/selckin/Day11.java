package be.selckin;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

public class Day11 {
    public static final String PART1_EXAMPLE = """
            ...#......
            .......#..
            #.........
            ..........
            ......#...
            .#........
            .........#
            ..........
            .......#..
            #...#.....
            """;

    public static void main(String[] args) throws IOException {
        part1(PART1_EXAMPLE, 1, 374);
        part1(PART1_INPUT, 1, 10276166);
        System.out.println("==============");
        part1(PART1_EXAMPLE, 10, 1030);
        part1(PART1_EXAMPLE, 100, 8410);
        part1(PART1_INPUT, 1_000_000, 598693078798L);

    }


    private static void part1(String input, int expandFactor, long expected) {
        long sum = calc(input, expandFactor);
        if (sum != expected)
            throw new RuntimeException(sum + " != " + expected);
    }

    private static long calc(String input, long expandFactor) {
        char[][] grid = parse(input);

        List<Integer> emptyRows = new ArrayList<>();
        for (int y = 0; y < grid.length; y++) {
            boolean hasGalaxy = false;
            for (char c : grid[y]) {
                if (c == '#')
                    hasGalaxy = true;
            }
            if (!hasGalaxy)
                emptyRows.add(y);
        }

        List<Integer> emptyCols = new ArrayList<>();
        for (int x = 0; x < grid[0].length; x++) {
            boolean hasGalaxy = false;
            for (char[] chars : grid) {
                if (chars[x] == '#')
                    hasGalaxy = true;
            }
            if (!hasGalaxy)
                emptyCols.add(x);
        }
        List<Point> galaxies = new ArrayList<>();
        for (int y = 0; y < grid.length; y++) {
            for (int x = 0; x < grid[0].length; x++) {
                if (grid[y][x] == '#') {

                    galaxies.add(new Point(
                            x + expand(expandFactor, emptyCols, x),
                            y + expand(expandFactor, emptyRows, y)
                    ));
                }
            }
        }

        long sum = 0;
        Set<Pair> seen = new HashSet<>();
        for (Point a : galaxies) {
            for (Point b : galaxies) {
                if (seen.add(a.compareTo(b) >= 0 ? new Pair(a, b) : new Pair(b, a)))
                    sum += distance(a, b);
            }
        }

        return sum;
    }

    private static long expand(long expandFactor, List<Integer> coords, int offset) {
        long count = countSmaller(coords, offset);
        if (count > 0)
            return count * expandFactor - (expandFactor > 1 ? count : 0);
        return 0;
    }

    public static long distance(Point a, Point b) {
        return Math.abs(b.x() - a.x()) + Math.abs(b.y() - a.y());
    }


    private static long countSmaller(List<Integer> emptyCols, int needle) {
        return emptyCols.stream().mapToInt(v -> v).filter(v -> v < needle).count();
    }


    public record Point(long x, long y) implements Comparable<Point> {
        @Override
        public int compareTo(Point o) {
            int xc = Long.compare(x(), o.x());
            if (xc != 0)
                return xc;
            return Long.compare(y(), o.y());
        }
    }

    public record Pair(Point a, Point b) {
    }

    private static char[][] parse(String input) {
        List<String> lines = input.lines().toList();

        char[][] grid = new char[lines.size()][lines.get(0).length()];
        for (int i = 0; i < lines.size(); i++) {
            String line = lines.get(i);
            grid[i] = line.toCharArray();
        }
        return grid;
    }

    public static final String PART1_INPUT = """
            .....#...............#......................................................................#.............................#..........#......
            ........................................#............................#......#...............................................................
            ..............................#..............#....................................#..............................................#..........
            ..............#........................................................................#....................................................
            ..#...........................................................................................#.............................................
            ..................#.....................................#.....#......................................#.........#.......#....................
            ...........#......................................#.....................#...........#................................................#......
            .............................#............................................................#.....................................#...........
            .....#..................#.................#.........................#......................................#................................
            ....................................#.................#........................#..........................................................#.
            ................#..............................#....................................................#.......................................
            ..............................................................#.........................#.......................#.....................#.....
            ............#...............#......................#.....................#..............................#...................................
            ......................................#...............................................................................#.....................
            .........................................................#..................................................................................
            ..............................................#.............................................................................................
            ..#.................#.....................................................................#.....#..........#..............#......#..........
            ..............................................................................#.............................................................
            ..........................................#.........................#..............................................#........................
            .....#........#.............#...........................#...........................................#.......................................
            ..................................#...............#.............#.................#..........................#.....................#........
            .......................................................................#....................................................................
            ...............................................................................................................................#.........#..
            #.......................................#....................................................#.........................#....................
            ........#...............#....................................#...........................................#..................................
            ...............................#............................................................................................................
            .........................................................#..................................................................................
            ..#..........................................#........................................#.............#............................#..........
            ......................#............................#.................#........#.............................................................
            .........#.......#...........................................................................#.....................#.........#.........#....
            ................................#............................................................................#..............................
            .........................................................................................#..................................................
            .#.........................................#.........#..........#.......................................................#...................
            ....................#.................#...............................................................#.....................................
            ............................................................................#...............................................................
            ........................#.........................................................................................#.................#.......
            .............#.......................................................#......................................................#...............
            .......#.................................#.....#..............................................................#.............................
            #...............................#...............................................................#.....................#.....................
            .....................................#...................#.......................#.....#.......................................#............
            ..........................#.................#......#...................................................................................#....
            ..............#.............................................................................................................................
            ...#..........................................................................#............................................#................
            .............................................................................................#.....................#......................#.
            .......................................#..........................................................................................#.........
            .......................................................................................................#....................................
            .....#.........#.................#.................#............#.........................#.................#...............................
            ............................#.....................................................#.........................................................
            ...........................................#................................................................................................
            ....................................#.......................#.........................#............................#.....#..................
            ............................................................................................................................................
            .....................#..................#................................#......#.....................................................#.....
            .......................................................#.........#...............................#.....#....................................
            ............#.................................................................................................................#.............
            ..............................................#..............#.......#.................................................#....................
            ................................................................................................................#...........................
            .........#.............................................................................#............#.......................................
            .............................#...........................................#.....#............................................................
            .....#..........#.....#...........#.............#.....#.............................................................................#.......
            ...........................................#............................................................#.....#.............................
            ......................................#.........................#.........................#.....................................#...........
            ............................................................................................................................................
            .......#.....#.....#........................................#.................................#.............................................
            .........................................#................................................................#.....#......#....................
            ........................#.......#..................#.................................#.......................................#.......#......
            ..............................................#.............................................................................................
            ...............................................................................#............................................................
            ......................................................#..........#..........................................................................
            ...#......#.................#.............#.............................#..........................#...............................#........
            .............................................................#........................#..........................#.........#................
            ......................................#....................................................#.............................................#..
            ............................................................................................................................................
            ...............#......#.......................#.....#.......................................................#...............................
            .#......#.......................#.........................#.......#....................................#....................................
            ...............................................................................................#........................#......#.......#....
            ............#...............#............#....................#........#..........#.........................................................
            ...............................................................................................................#............................
            ..........................................................................................................#.................#...............
            ......................#........#.........................................................................................................#..
            ....................................................................................#.....#.....#....................#......................
            .#.........#...............#........................................#...............................................................#.......
            ..................#......................................................#..........................#.......................................
            .................................#.............#................................................................#.......#...................
            ........................#......................................................#..............#................................#............
            .....#..........................................................#.....#.................#..................................................#
            .....................................#......#.........#...............................................#.....................................
            ............................................................................................................................................
            ............................................................................................................................................
            .................................#..........................................#................#...................#..............#...........
            .......#....................#............#.............................................#...................................#................
            ..#................#........................................#.......#..............................#........................................
            ........................#...........................................................................................................#.......
            ...........#..........................................#.........................#......................#....................................
            ...........................................#................................................................................................
            ......#...............................................................................#.........#...........................................
            ............................#.....................#................#........................................#...........#...................
            ..................#.........................................#...............................................................................
            ........................#...............#................................#.......#..............................#............#..............
            ............#......................#.................#..................................................#..................................#
            ..#................................................................................................#........................................
            .........................................................................................................................#..................
            ..................................................................#................................................#................#.......
            .......#.....................................#..............................................................................................
            .................#...............#......#.....................#.............................................................................
            ....................................................................................#..................................#....................
            ..............................................................................................#............#................................
            ....#......................#................................................................................................................
            ......................................................#.................................#..........................#.............#..........
            ..........#.................................................................................................................#...............
            .................................#..........#..................................#............................................................
            .......................................................................................................................................#....
            .......................................#..................................................................#......#..........................
            .............................#.........................................................#.......#............................................
            .........#....................................#............#.................................................................#..............
            ...#...............................................................................#.................#......................................
            ..................................................................................................................................#.........
            ....................#.............#...................................................................................#....................#
            ....................................................#...........#...........#...............................................................
            .........................................................................................................#..................................
            ..........#...............................#............................#....................................................................
            .............................................................#....................#.............................#..............#............
            .#...............#..........................................................................#..........................................#....
            ............................#...............................................................................................................
            ............#......................................#............#..................................................................#........
            .......#...............................................................................................................#....................
            ..................................#.......#..........................#........#...............#..........#....................#.............
            ....................#....................................#............................#..........................#.......................#..
            ..............................................................#.............................................................................
            ..#............................#............................................................................#...............................
            ..............#.....................#...............................................................................................#.......
            ..........................#........................................#....................................#...........#.......................
            ..........................................#.................................#.................#.............................................
            ................................................#...........#..........#.....................................................#..............
            .........#..................................................................................................................................
            ...................................................................................#............................#.......#...................
            ....#.............................#.............................#.......................................................................#...
            .........................................#.........................................................#........................................
            ....................#...........................................................................................................#...........
            ..............#........................................#..................................#...................#......................#......
            .........#.................#........................................#...........#........................................#..................
            """;

}


